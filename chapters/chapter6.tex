% !TeX root = ../main.tex

\chapter{总结与展望}
随着处理器技术和体系结构的持续发展，对于大规模高性能计算需要的不断增多，更多的超级计算机采用异构众核的架构进行处理器的设计。多次登顶Top500 排行榜的我国自主研发超级计算机神威·太湖之光就是由异构众核处理器 SW26010 所构成，为我国计算机和科学计算领域的发展打下了坚实的基础。现如今大量的计算应用软件是直接部署在通用计算平台上的，而通过平台的硬件架构与申威处理器而结构有着较大差异，这也为计算资源的高效利用提供了困难。本文选择将分子动力学软件LAMMPS 移植到申威平台上，选择eFF 算法进行并行和优化方案的设计。通过提出多种并行方案，充分利用 SW26010 处理器上海量的计算单元，并针对访存开销和带宽受限的问题，给出了多种优化策略，进行从不同角度解决相关问题。这里希望能够通过对LAMMPS 优化策略的设计和应用算法上的特征分析为申威平台上其他科学应用的优化理清思路。

\section{工作总结}
本文研究工作主要分为以下两个方面：

\subsubsection{对 LAMMPS 计算的热点分析及在申威众核平台上的并行实现}
LAMMPS 作为分子动力学领域内模拟体系涵盖最全的计算软件之一，针对上面的 eFF 势函数计算本文总结了计算的主要流程，包括数据处理，模拟与输出过程。利用性能分析工具对 eFF 势函数计算部分进行瓶颈与热点的分析。并给出了在这部分计算中热点函数的代码框架和数据结构并仔细分析了这个热点的计算流程，找到 eFF 算法在计算时表现出来的应用特征，为后面具体优化方案的设计提供参考。对于 SW26010 异构众核处理器上应用的并行加速，需要对从核阵列资源进行高效分配和管理。才能充分利用整个处理器芯片的计算性能。首先，我们对 eFF 势函数计算移植到主核上，为并行与优化方案提供对照版本。接下来通过热点计算流程的分析，将两体势计算中的两层循环进行选择拆分，保证对每个从核在相同周期内的计算量相对一致，以此解决负载均衡的问题。分析中心粒子在进行受力结果更新时带来的写数据依赖的问题，同时提出副本归约的方法，解决内层循环并行中的划分问题，选择对粒子规模更大的外层循环进行拆分，减小计算时的访存开销，提高计算计算粒度，将体系中的粒子均匀划分到从核阵列中，并由从核自身负责结果的暂存，最后统一进行数据的更新和写回。

\subsubsection{设计不同的优化策略提高 eFF 势计算性能}
本文给出了多种并行方案，访存优化方案和从核通信方案的设计策略，针对eFF 势函数计算在申威众核平台上的访存开销过大，从核带宽首先等问题进行仔细了分析。首先，对于从核计算时受力结果的累加，设计了高效的从核通信归约策略，利用申威平台从核寄存器通信的方法和基于二叉树的设计思路，将结果累加到指定从核并写回主存，同时还利用从核同步解决了结果不一致的问题。接下来设计了一种单端更新的并行方案，通过平衡算法中的计算量和访存开销，来提升整体的计算效率。通过修改邻接表的方法，在占用更少的从核LDM 空间的同时，也支持在更大粒子体系下的模拟计算。利用DMA 访存方法将大块连续的粒子数据一次读取到从核上，缓解了从核访存带宽的压力，并分析在热点计算中的常用数据，将这部分粒子信息在计算之前暂存到从核LDM 中，降低频繁访存的开销。通过对邻居粒子的访存行为的局部性特征分析，设计了软件 Cache 方法，在与软件Cache 性能相近的从核LDM 中分配空间来利用计算的局部性特征，进一步降低访存开销。最后利用向量化和向量混洗指令，在计算内部确定向量化位置，解决了包括读取离散粒子数据和向量计算分支等问题。

\section{未来工作展望}
在当前研究工作的基础上，本文以如下几个方面对LAMMPS 势函数计算进行并行优化方面的扩展：

1. 本文给出了多种并行优化方案，通过将计算热点函数加载到从核阵列，并采用多种优化策略进行访存，计算，通信等特性的性能贾斯。由于申威平台上设计架构和软硬件的限制，eFF 势函数计算仍无法达到理想的性能状态。为了进一步利用众核平台的特性，这里设计了几种优化方案进一步提高整体性能：（1）在SW26010 处理器中，从核阵列的性能发挥很大程度上决定了整体性能的表现，其中访存开销又占据了很大比重。在对从核阵列的设计分配中，可以将部分从核由计算任务中剥离出来，作为调度核心来使用，主要负责从核阵列的访存和通信，这样就能够用较小的计算代价来换取更好的访存性能。（2）在进行并行模式的设计时，从核主要负责热点函数的计算，与此同时主核在等待从核任务的完成，而不进行其他操作。这里可以将部分热点计算划分给主核，或者执行通信和I/O 操作，使得主核资源能够被充分利用。（3）在将热点函数加载到从核阵列上并进行一些列优化后，其时间占比在整个计算中已经是比较小的一部分，根据 Amdahl定律[41] 和 Gustafson 定律[42] 继续进行该函数的性能优化得到的提升相当有限，所以接下来可以将其他相对耗时的非热点函数进行并行优化。

2. 由于机时和实验规模的限制，在整个模拟过程中所采用的最大进程规模为65536 个。在后续逐步增大计算规模的同时，可以通过设计更加复杂的模拟体系和更大的粒子体系进行完备的实验测试。在计算规模增大也同样会使访存，计算，通信等方面的问题逐步显露，并由此进行更加有效的性能优化方案的设计。
